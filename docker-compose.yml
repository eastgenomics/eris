version: "3.9"

services:
  eris_db:
    container_name: eris-db
    # platform: linux/amd64
    image: postgres:12.15-bullseye
    expose:
      - 5432
    restart: always
    volumes:
      - eris_db:/var/lib/postgresql/data/
    environment:
      - POSTGRES_DB=eris # change based on DB
      - POSTGRES_USER=postgres # change based on USER
      - POSTGRES_PASSWORD=root # change based on PASSWORD
  eris_web:
    container_name: eris-web
    platform: linux/amd64
    image: eris-web:1.0
    build: .
    command: bash -c "python manage.py collectstatic --noinput && gunicorn core.wsgi:application --bind :8009"
    env_file:
      - .env # change to relative path when docker compose build
    volumes:
      - eris_static:/app/staticfiles
    expose:
      - 8009
    depends_on:
      - eris_db
    restart: always
  eris_celery:
    container_name: eris-eris_celery
    platform: linux/amd64
    image: eris-celery:1.0
    build: .
    command: celery -A core worker -l INFO
    env_file:
      - .env # change to relative path when docker compose build
    depends_on:
      - eris_redis
      - eris_web
  eris_nginx:
    container_name: eris-nginx
    # platform: linux/amd64
    image: nginx:1.23
    volumes:
      - eris_static:/staticfiles
      - /Users/jason/Github/eris/nginx:/etc/nginx/conf.d
    environment:
      - VIRTUAL_HOST=localhost # change based on HOST
      - VIRTUAL_PATH=/eris # change based on PATH
    expose:
      - 8010 # make sure nginx/nginx.conf PORT is changed too
    depends_on:
      - eris_web
  eris_redis:
    container: eris-redis
    image: redis:7-alpine
    restart: always
    ports:
      - 6379:6379
    command: redis-server --save 20 1 --loglevel warning
    volumes:
      - eris_redis:/data

volumes:
  eris_db:
  eris_static:
  eris_redis:


networks:
  default:
    name: nginx-default # change based on NETWORK
    external: true
